<%- include("partials/header", { title: "Chat", bodyClass: "dashboard-bg" }) %>
<%- include("partials/navbar", { user: user }) %>

<div class="container container-max py-5">
  <div class="page-header">
    <div>
      <h2 class="mb-1">Chat</h2>
      <p>
        Booking #<%= bookingId %> • <%= context.storage_title || 'Storage' %>
        <br />
        <span class="text-muted">
          <% if (role === 'customer') { %>
            Provider: <%= context.provider_name || ('User #' + context.provider_id) %>
          <% } else { %>
            Customer: <%= context.customer_name || ('User #' + context.customer_id) %>
          <% } %>
        </span>
      </p>
    </div>
  </div>

  <div class="card shadow-soft">
    <div class="card-body">
      <div class="chat-thread">
        <% if (!messages || messages.length === 0) { %>
          <div class="text-muted">No messages yet.</div>
        <% } else { %>
          <% messages.forEach(m => { %>
            <div class="chat-message <%= m.sender_role === role ? 'chat-out' : 'chat-in' %>">
              <div class="chat-meta">
                <%= m.sender_role === 'customer' ? 'Customer' : 'Provider' %>
                • <%= new Date(m.created_at).toLocaleString() %>
              </div>
              <div class="chat-bubble"><%= m.message %></div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <form method="POST" action="<%= role === 'customer' ? '/chat/' + bookingId + '/send' : '/provider/chat/' + bookingId + '/send' %>" class="mt-3" id="chatForm">
        <div class="input-group">
          <input type="text" name="message" class="form-control" placeholder="Type a message" required id="chatInput" />
          <button class="btn btn-primary" type="submit">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  (function () {
    const chatId = <%- JSON.stringify(chatId) %>;
    const role = <%- JSON.stringify(role) %>;
    const userId = <%- JSON.stringify(user && (user.id || user.user_id)) %>;
    const form = document.getElementById("chatForm");
    const input = document.getElementById("chatInput");
    const thread = document.querySelector(".chat-thread");

    if (!chatId || !form || !input || !thread) return;

    const socket = io();
    socket.emit("chat:join", { chatId });

    const appendMessage = (payload) => {
      const wrap = document.createElement("div");
      wrap.className = `chat-message ${payload.sender_role === role ? "chat-out" : "chat-in"}`;

      const meta = document.createElement("div");
      meta.className = "chat-meta";
      const senderLabel = payload.sender_role === "customer" ? "Customer" : "Provider";
      const ts = new Date(payload.created_at || Date.now()).toLocaleString();
      meta.textContent = `${senderLabel} • ${ts}`;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";
      bubble.textContent = payload.message;

      wrap.appendChild(meta);
      wrap.appendChild(bubble);
      thread.appendChild(wrap);
      thread.scrollTop = thread.scrollHeight;
    };

    socket.on("chat:new", (payload) => {
      if (!payload || payload.chatId !== chatId) return;
      appendMessage(payload);
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const message = (input.value || "").trim();
      if (!message) return;
      socket.emit("chat:send", { chatId, senderRole: role, senderId: userId, message });
      input.value = "";
    });
  })();
</script>

<%- include("partials/footer") %>
