<%- include("partials/header", { title: "Provider Dashboard" }) %>
<%- include("partials/navbar", { user: user }) %>

<div class="container container-max py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">Provider Dashboard</h3>
      <div class="small-muted">Manage your listings and bookings.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-dark" href="/provider/storage">My Listings</a>
      <a class="btn btn-dark" href="/provider/bookings">Bookings</a>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card shadow-soft p-4 h-100">
        <h6 class="mb-2">KYC Status</h6>
        <% if (!kyc) { %>
          <div class="alert alert-warning mb-0">Not submitted</div>
          <a class="btn btn-primary w-100 mt-2" href="/provider/kyc">Submit KYC</a>
        <% } else { %>
          <div class="alert <%= kyc.status === 'APPROVED' ? 'alert-success' : (kyc.status === 'REJECTED' ? 'alert-danger' : 'alert-warning') %> mb-0">
            <strong><%= kyc.status %></strong>
          </div>
          <a class="btn btn-outline-primary w-100 mt-2" href="/provider/kyc">View / Update</a>
        <% } %>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-soft p-4 h-100">
        <h6 class="mb-2">Summary</h6>
        <div class="d-flex justify-content-between">
          <div class="small-muted">Bookings</div>
          <div class="fw-semibold"><%= summary.total_bookings || 0 %></div>
        </div>
        <div class="d-flex justify-content-between">
          <div class="small-muted">Revenue</div>
          <div class="fw-semibold">$<%= Number(summary.total_revenue || 0).toFixed(2) %></div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-soft p-4 h-100">
        <h6 class="mb-2">Quick actions</h6>
        <a class="btn btn-dark w-100 mb-2" href="/provider/storage/add" <%= (kyc && kyc.status === 'APPROVED') ? '' : 'disabled' %>>Add new listing</a>
        <% if (!kyc || kyc.status !== 'APPROVED') { %>
          <div class="small-muted">You must be KYC-approved to create listings.</div>
        <% } %>
        <a class="btn btn-outline-dark w-100 mt-2" href="/provider/promotions">Manage Promotions</a>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-2">
    <div class="col-lg-4">
      <div class="card shadow-soft p-4 h-100">
        <h6 class="mb-2">Promotions</h6>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small-muted">Active promos</div>
          <div class="fw-semibold"><%= activePromos || 0 %></div>
        </div>
        <a class="btn btn-primary w-100 mt-3" href="/provider/promotions">Create / Manage</a>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-soft p-4 h-100">
        <h6 class="mb-2">Reviews & Trust</h6>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small-muted">Average rating</div>
          <div class="fw-semibold"><%= Number(reviewSummary.avg_rating || 0).toFixed(1) %>â˜…</div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small-muted">Total reviews</div>
          <div class="fw-semibold"><%= reviewSummary.review_count || 0 %></div>
        </div>
        <div class="mt-3">
          <canvas id="reviewTrendChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-soft p-4 h-100">
        <h6 class="mb-2">Low Occupancy Alerts</h6>
        <% if (!lowOccupancy || lowOccupancy.length === 0) { %>
          <div class="alert alert-light mb-0">No alerts.</div>
        <% } else { %>
          <div class="d-grid gap-2">
            <% lowOccupancy.forEach(s => { %>
              <div class="border rounded-4 p-2">
                <div class="fw-semibold"><%= s.title %></div>
                <div class="small-muted">
                  <%= s.available_units %>/<%= s.total_units %> units available
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="mt-4 card shadow-soft p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Your latest listings</h5>
      <a class="btn btn-outline-dark btn-sm" href="/provider/storage">View all</a>
    </div>

    <% if (!listings || listings.length === 0) { %>
      <div class="alert alert-light mb-0">No listings yet.</div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Location</th>
              <th>Units</th>
              <th>Price/day</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% listings.slice(0,5).forEach(s => { %>
              <tr>
                <td class="fw-semibold"><%= s.title %></td>
                <td><%= (s.storage_type || 'physical').toUpperCase() %></td>
                <td><%= s.location || 'N/A' %></td>
                <td><%= s.available_units %>/<%= s.total_units %></td>
                <td>$<%= s.price_per_day || s.price %></td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="/provider/storage/edit/<%= s.storage_id %>">Edit</a>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const reviewTrend = <%- JSON.stringify(reviewTrend || []) %>;
  const trendSorted = [...reviewTrend].sort((a, b) => String(a.month).localeCompare(String(b.month)));
  const labels = trendSorted.map(r => r.month);
  const values = trendSorted.map(r => Number(r.avg_rating || 0));
  const ctx = document.getElementById("reviewTrendChart");
  if (ctx) {
    new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label: "Avg Rating", data: values, tension: 0.35 }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { min: 0, max: 5 } }
      }
    });
  }
</script>

<%- include("partials/footer") %>
