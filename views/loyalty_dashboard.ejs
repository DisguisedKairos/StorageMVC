<%- include("partials/header", { title: "Loyalty Points" }) %>
<%- include("partials/navbar", { user: user }) %>

<div class="container container-max py-5">
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="mb-1">Your Loyalty Points</h2>
      <p class="text-muted">Earn points on every purchase and redeem them for discounts!</p>
    </div>
  </div>

  <!-- Points Summary Cards -->
  <div class="row g-4 mb-5">
    <!-- Current Points Card -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color: white;">
        <div class="card-body text-center">
          <h6 class="card-title text-uppercase opacity-75 mb-2">Available Points</h6>
          <h2 class="card-text fw-bold mb-3"><%= loyalty_points.toLocaleString() %></h2>
          <p class="mb-0 small">Redeemable for $<%= (loyalty_points / 100 * redeem_rate).toFixed(2) %> discount</p>
        </div>
      </div>
    </div>

    <!-- Tier Card -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body text-center">
          <h6 class="card-title text-uppercase opacity-75 mb-2">Current Tier</h6>
          <h2 class="card-text fw-bold mb-2">‚≠ê <%= tier_name %></h2>
          <p class="mb-0 small"><%= earn_rate %>x points ‚Ä¢ <%= (redeem_rate * 100) %>% redeem value</p>
        </div>
      </div>
    </div>

    <!-- Lifetime Points Card -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <div class="card-body text-center">
          <h6 class="card-title text-uppercase opacity-75 mb-2">Lifetime Points</h6>
          <h2 class="card-text fw-bold mb-2"><%= lifetime_points.toLocaleString() %></h2>
          <p class="mb-0 small">Total earned</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Next Tier Progress -->
  <% if (points_needed && points_needed > 0) { %>
  <div class="card border-0 shadow-sm mb-5">
    <div class="card-body">
      <h5 class="card-title mb-3">Progress to <%= next_tier %></h5>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar" role="progressbar" 
             style="width: <%= Math.max(0, Math.min(100, ((loyalty_points / (loyalty_points + points_needed)) * 100))) %>%; background: linear-gradient(90deg, #4ECDC4, #44A08D);"
             aria-valuenow="<%= loyalty_points %>" aria-valuemin="0" aria-valuemax="<%= loyalty_points + points_needed %>">
          <span class="text-white fw-bold small"><%= points_needed %> more points needed</span>
        </div>
      </div>
      <small class="text-muted mt-2 d-block">Reach <%= next_tier %> tier to earn <%= (tiers.find(t => t.tier_name === next_tier)?.earn_rate || 1.5) %>x points and enjoy better redeem rates!</small>
    </div>
  </div>
  <% } %>

  <!-- Tier Benefits -->
  <div class="card border-0 shadow-sm mb-5">
    <div class="card-body">
      <h5 class="card-title mb-4">Loyalty Tiers &amp; Benefits</h5>
      <div class="row g-3">
        <% tiers.forEach(tier => { %>
          <div class="col-md-<%= tiers.length === 3 ? 4 : 6 %>">
            <div class="card border-start-3 border-0" style="border-color: <%= tier.tier_name === tier_name ? '#4ECDC4' : '#e0e0e0' %>;">
              <div class="card-body">
                <h6 class="card-title mb-2 <%= tier.tier_name === tier_name ? 'text-success fw-bold' : '' %>">
                  <%= tier.tier_name %> <% if (tier.tier_name === tier_name) { %>‚úì<% } %>
                </h6>
                <p class="small text-muted mb-2">
                  <% if (tier.max_points) { %>
                    <%= tier.min_points %> - <%= tier.max_points %> points
                  <% } else { %>
                    <%= tier.min_points %>+ points
                  <% } %>
                </p>
                <ul class="small mb-0 ps-3">
                  <li><strong><%= tier.earn_rate %>x</strong> points per $1</li>
                  <li><strong><%= (tier.redeem_rate * 100) %>%</strong> redeem value</li>
                  <li><strong><%= (tier.bonus_multiplier * 100) %>%</strong> bonus</li>
                </ul>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <!-- How It Works -->
  <div class="card border-0 shadow-sm mb-5">
    <div class="card-body">
      <h5 class="card-title mb-4">How It Works</h5>
      <div class="row g-4">
        <div class="col-md-4 text-center">
          <div style="font-size: 40px; margin-bottom: 15px;">üõí</div>
          <h6 class="fw-bold mb-2">1. Shop &amp; Earn</h6>
          <p class="small text-muted">Every dollar you spend earns loyalty points based on your tier</p>
        </div>
        <div class="col-md-4 text-center">
          <div style="font-size: 40px; margin-bottom: 15px;">üìà</div>
          <h6 class="fw-bold mb-2">2. Level Up</h6>
          <p class="small text-muted">Accumulate points to reach higher tiers and unlock better benefits</p>
        </div>
        <div class="col-md-4 text-center">
          <div style="font-size: 40px; margin-bottom: 15px;">üí∞</div>
          <h6 class="fw-bold mb-2">3. Save Big</h6>
          <p class="small text-muted">Redeem points for discounts on your next purchase</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row g-3 mb-5">
    <div class="col-md-6">
      <a href="/loyalty/redeem" class="btn btn-primary btn-lg w-100">
        Redeem Points for Discount
      </a>
    </div>
    <div class="col-md-6">
      <a href="/storage" class="btn btn-outline-primary btn-lg w-100">
        Continue Shopping
      </a>
    </div>
  </div>

  <!-- Transaction History -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
      <h5 class="mb-0">Points History</h5>
    </div>
    <div class="card-body">
      <% if (!transactions || transactions.length === 0) { %>
        <p class="text-muted text-center py-4">No points transactions yet. Start shopping to earn points!</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Points</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <% transactions.forEach(tx => { %>
                <tr>
                  <td class="text-muted small">
                    <%= tx.created_at_display %>
                  </td>
                  <td>
                    <% if (tx.transaction_type === 'EARNED') { %>
                      <span class="badge bg-success">Earned</span>
                    <% } else if (tx.transaction_type === 'REDEEMED') { %>
                      <span class="badge bg-warning">Redeemed</span>
                    <% } else if (tx.transaction_type === 'BONUS') { %>
                      <span class="badge bg-info">Bonus</span>
                    <% } else { %>
                      <span class="badge bg-secondary"><%= tx.transaction_type %></span>
                    <% } %>
                  </td>
                  <td class="fw-bold <%= tx.points > 0 ? 'text-success' : 'text-danger' %>">
                    <%= tx.points > 0 ? '+' : '' %><%= tx.points %>
                  </td>
                  <td class="text-muted"><%= tx.description || '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
</div>

<%- include("partials/footer") %>
