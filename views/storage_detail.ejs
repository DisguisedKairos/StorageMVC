<%- include("partials/header", { title: storage.title }) %>
<%- include("partials/navbar", { user: user }) %>

<div class="container container-max py-5">
  <a href="/storage" class="btn btn-outline-secondary btn-sm mb-3">&larr; Back</a>

  <div class="row g-4">
    <div class="col-md-7">
      <div class="card shadow-soft p-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h3 class="mb-1"><%= storage.title %></h3>
            <div class="small-muted"><%= storage.location || 'N/A' %> • <%= storage.size %> • <%= (storage.storage_type || 'physical').toUpperCase() %></div>
          </div>
          <span class="badge bg-dark"><%= Number(storage.avg_rating || 0).toFixed(1) %>★ (<%= storage.review_count || 0 %>)</span>
        </div>

        <hr>

        <p class="mb-1"><strong>Availability:</strong> <%= storage.available_units %>/<%= storage.total_units %> units</p>
        <p class="mb-1"><strong>Dynamic Price Today:</strong> $<%= storage.dynamic_price_per_day || (storage.price_per_day || storage.price) %> / day</p>
        <p class="mb-3 small-muted">Base price: $<%= storage.price_per_day || storage.price %> / day (dynamic pricing changes with demand)</p>

        <p><%= storage.description || 'No description provided.' %></p>

        <% if (storage.latitude && storage.longitude) { %>
          <div class="mt-3">
            <div class="small-muted mb-2"><strong>Map (quick view)</strong></div>
            <iframe
              width="100%"
              height="260"
              style="border:0;border-radius:12px;"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              src="https://www.google.com/maps?q=<%= storage.latitude %>,<%= storage.longitude %>&output=embed">
            </iframe>
          </div>
        <% } else { %>
          <div class="alert alert-light mt-3 mb-0">Map not available for this listing.</div>
        <% } %>

        <div class="mt-3 d-grid gap-2">
          <% if (user && user.role === 'customer') { %>
            <form action="/cart/add" method="POST">
              <input type="hidden" name="storage_id" value="<%= storage.storage_id %>">
              <button class="btn btn-primary" <%= (storage.available_units || 0) <= 0 ? 'disabled' : '' %>>Add to Cart</button>
            </form>
          <% } else if (!user) { %>
            <a class="btn btn-outline-primary" href="/login">Login to Rent</a>
          <% } else { %>
            <button class="btn btn-secondary" disabled>Not available for this role</button>
          <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card shadow-soft p-4 mb-4">
        <h5 class="mb-3">Reviews</h5>

        <% if (reviews && reviews.length > 0) { %>
          <div class="d-grid gap-3">
            <% reviews.forEach(r => { %>
              <div class="border rounded-4 p-3">
                <div class="d-flex justify-content-between">
                  <div class="fw-semibold"><%= r.user_name %></div>
                  <div class="fw-semibold"><%= r.rating %>★</div>
                </div>
                <div class="small-muted"><%= new Date(r.created_at).toLocaleString() %></div>
                <% if (r.comment) { %>
                  <div class="mt-2"><%= r.comment %></div>
                <% } %>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="alert alert-warning mb-0">No reviews yet.</div>
        <% } %>
      </div>

      <div class="card shadow-soft p-4">
        <h5 class="mb-3">Leave a review</h5>
        <% if (user && user.role === 'customer') { %>
          <form method="POST" action="/storage/<%= storage.storage_id %>/review">
            <div class="mb-2">
              <label class="form-label">Rating</label>
              <select name="rating" class="form-select" required>
                <option value="5">5 - Excellent</option>
                <option value="4">4 - Good</option>
                <option value="3">3 - OK</option>
                <option value="2">2 - Poor</option>
                <option value="1">1 - Bad</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Comment (optional)</label>
              <textarea name="comment" class="form-control" rows="3" placeholder="Your experience..."></textarea>
            </div>
            <button class="btn btn-dark w-100">Submit</button>
          </form>
          <hr class="my-4">
          <h6 class="mb-2">Report an issue</h6>
          <form method="POST" action="/storage/<%= storage.storage_id %>/complaint">
            <div class="mb-2">
              <label class="form-label">Title</label>
              <input name="title" class="form-control" placeholder="Describe the issue" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Details</label>
              <textarea name="description" class="form-control" rows="3" placeholder="Explain what happened..." required></textarea>
            </div>
            <button class="btn btn-outline-danger w-100">Submit Complaint</button>
          </form>
        <% } else { %>
          <div class="alert alert-light mb-0">Login as a customer to leave a review.</div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include("partials/footer") %>
